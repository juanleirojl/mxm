<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Relatórios')}"></head>
<body>
    <div class="wrapper">
        <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>
        <div class="main-panel">
            <div th:replace="~{fragments/navbar :: navbar}"></div>
            <div class="container">
                <div class="page-inner">
                    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
                        <div>
                            <h3 class="fw-bold mb-3">Relatório Geral</h3>
                        </div>
                    </div>

					<!-- Filtros -->
					<form th:action="@{/relatorios}" method="get" class="row g-3">
					    <div class="col-md-3">
					        <label for="cliente" class="form-label">Cliente</label>
					        <select id="cliente" name="clienteId" class="form-control">
					            <option value="">Todos</option>
					            <option th:each="cliente : ${clientes}" 
					                    th:value="${cliente.id}" 
					                    th:text="${cliente.nome}"
					                    th:selected="${cliente.id == clienteSelecionado}">
					            </option>
					        </select>
					    </div>
					    <div class="col-md-3">
					        <label for="cimento" class="form-label">Cimento</label>
					        <select id="cimento" name="cimentoId" class="form-control">
					            <option value="">Todos</option>
					            <option th:each="cimento : ${cimentos}" 
					                    th:value="${cimento.id}" 
					                    th:text="${cimento.marca}"
					                    th:selected="${cimento.id == cimentoSelecionado}">
					            </option>
					        </select>
					    </div>
					    <div class="col-md-3">
					        <label for="dataDe" class="form-label">Data De</label>
					        <input type="date" id="dataDe" name="dataDe" class="form-control" th:value="${dataSelecionadaDe}">
					    </div>
					    <div class="col-md-3">
					        <label for="dataAte" class="form-label">Data Até</label>
					        <input type="date" id="dataAte" name="dataAte" class="form-control" th:value="${dataSelecionadaAte}">
					    </div>
						<div class="col-12 d-flex">
					        <button type="submit" class="btn btn-primary me-2">Filtrar</button>
					        <button type="button" class="btn btn-secondary" id="limparFiltros">Limpar Filtros</button>
					    </div>
					</form>

					<!-- Tabela de Relatórios -->
					<div class="row mt-4">
					    <div class="col-md-12">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Resultados da Consulta</h4>
					            </div>
					            <div class="card-body">
					                <div class="table-responsive" >
					                    <table id="relatorioTable" class="table table-striped table-hover">
											<thead>
											    <tr>
											        <th>Data</th>
											        <th>Número</th>
											        <th>Placa</th>
											        <th>Motorista</th>
											        <th>Cliente</th>
											        <th>Cimento</th>
											        <th>Quantidade</th>
											        <th>Compra</th>
											        <th>Venda</th>
											        <th>Frete</th>
											        <th>Valor Nota Fábrica</th>
											        <th>Lucro Final</th>
											        <th>Imposto</th>
											        <th>Valor Parcial</th>
											        <th>Valor Restante</th>
											        <th>Imposto por Saco</th>
											        <th>Frete por Saco</th>
											        <th>Custo por Saco</th>
											        <th>Lucro por Saco</th>
											    </tr>
											</thead>

											<tbody>
											    <tr th:each="pedido : ${pedidosFiltrados}">
											        <td th:text="${#temporals.format(pedido.data, 'dd/MM/yyyy')}"></td>
											        <td th:text="${pedido.numero}"></td>
											        <td th:text="${pedido.placa}"></td>
											        <td th:text="${pedido.motorista}"></td>
											        <td th:text="${pedido.cliente.nome}"></td>
											        <td th:text="${pedido.cimento.marca}"></td>
											        <td th:text="${pedido.quantidade}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.precoCimentoComprado)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.precoCimentoVendido)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.frete)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.valorNotaFabrica)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.lucroFinal)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.imposto)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.valorParcial)}"></td>
													<td th:text="${#numbers.formatCurrency(pedido.valorReceberCliente - (pedido.valorParcial ?: 0))}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.impostoPorSaco)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.fretePorSaco)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.custoSaco)}"></td>
											        <td th:text="${#numbers.formatCurrency(pedido.lucroPorSaco)}"></td>
											    </tr>
											</tbody>

											<tfoot>
											    <tr class="fw-bold">
											        <td colspan="6">Total:</td>
											        <td th:text="${totalQuantidade}"></td>
											        <td></td>
											        <td></td>
											        <td th:text="${#numbers.formatCurrency(totalFrete)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalValorNotaFabrica)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalLucroFinal)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalImposto)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalValorParcial)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalValorRestante)}"></td> <!-- ✅ Agora exibe a soma do Valor Restante -->
											        <td th:text="${#numbers.formatCurrency(totalImpostoPorSaco)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalFretePorSaco)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalCustoSaco)}"></td>
											        <td th:text="${#numbers.formatCurrency(totalLucroPorSaco)}"></td>
											    </tr>
											</tfoot>

					                    </table>
					                </div>
					            </div>
					        </div>
					    </div>
					</div>

                </div>
                <footer th:replace="~{layout :: footer}"></footer>
            </div>
        </div>
        <div th:replace="~{fragments/scripts :: scripts}"></div>
    </div>
	
	<script>
		
		$(document).ready(function() {
			           $('#relatorioTable').DataTable({
			               "paging": false,
			               "searching": false,
			               "ordering": false,
						"order": [],
			               "info": false,
			               "lengthMenu": [10, 20, 50],
			               "language": {
			                   "url": "/i18n/Portuguese-Brasil.json"
			               }
			           });
			       });
				   
	    document.getElementById("dataDe").addEventListener("change", function() {
	        let dataDe = this.value;
	        document.getElementById("dataAte").value = dataDe;
	    });
		
		document.getElementById("limparFiltros").addEventListener("click", function() {
		        let form = document.querySelector("form");
		        form.reset(); // Reseta os campos do formulário

		        // Removendo manualmente valores de selects e inputs de data para garantir que fiquem vazios
		        document.getElementById("cliente").value = "";
		        document.getElementById("cimento").value = "";
		        document.getElementById("dataDe").value = "";
		        document.getElementById("dataAte").value = "";
		    });
	</script>

						
</body>
</html>
