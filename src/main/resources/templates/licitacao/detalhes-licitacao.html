<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Detalhes da Licita√ß√£o')}"></head>
<body>
    <div class="wrapper">
        <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>
        <div class="main-panel">
            <div th:replace="~{fragments/navbar :: navbar}"></div>
            <div class="container">
                <div class="page-inner">
                    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-3">
                        <div>
                            <h3 class="fw-bold mb-2">Licita√ß√£o: <span th:text="${licitacao.nome}"></span></h3>
                        </div>
						<div class="ms-md-auto py-2 py-md-0">
                            <button class="btn btn-primary btn-round" onclick="abrirModalTransacao('criar')">Nova Transa√ß√£o</button>
                        </div>
                    </div>

					<!-- üìå Linha de Saldo Atual (Destaque) -->
					<div class="row mb-3">
					    <div class="col-md-12">
					        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded border shadow-sm" style="height: 60px;">
					            <h4 class="fw-bold text-muted m-0">Saldo Atual:</h4>
					            <h2 id="saldoAtual"
					                class="fw-bold m-0"
					                th:text="'R$ ' + ${#numbers.formatDecimal(licitacao.saldoAtual, 1, 2)}"
					                th:classappend="${licitacao.saldoAtual < 0} ? 'text-danger' : 'text-success'">
					            </h2>
					        </div>
					    </div>
					</div>

					
					<!-- üìå Mensagem de sucesso -->
					<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
					    <span th:text="${successMessage}"></span>
					    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
					</div>

					<!-- üìå Mensagem de erro -->
					<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
					    <span th:text="${errorMessage}"></span>
					    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
					</div>

                    <!-- üìå Tabela de Transa√ß√µes -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Transa√ß√µes da Licita√ß√£o</h4>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="transacoes-tabela" class="display table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Data</th>
                                                    <th>Descri√ß√£o</th>
                                                    <th>Valor</th>
                                                    <th>Tipo</th>
                                                    <th>Categoria</th>
                                                    <th>Origem/Destino</th>
                                                    <th>M√©todo Pagamento</th>
                                                    <th>Respons√°vel</th>
													<th>A√ß√µes</th> <!-- üìå Nova Coluna -->
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="transacao : ${transacoes}">
													<td data-order="${#temporals.format(transacao.data, 'yyyyMMddHHmmss')}"
													    th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy HH:mm')}">
													</td>

                                                    <td th:text="${transacao.descricao}"></td>
                                                    <td th:text="'R$ ' + ${#numbers.formatDecimal(transacao.valor, 1, 2)}"></td>
                                                    <td th:text="${transacao.tipoTransacao}"></td>
                                                    <td th:text="${transacao.categoriaNome}"></td>
                                                    <td th:text="${transacao.origemDestino}"></td>
                                                    <td th:text="${transacao.metodoPagamento}"></td>
                                                    <td th:text="${transacao.responsavelNome}"></td>
													<td>
									                    <!-- Bot√£o Editar -->
									                    <button class="btn btn-sm btn-primary"
									                        th:data-id="${transacao.id}"
									                        th:data-descricao="${transacao.descricao}"
									                        th:data-valor="${transacao.valor}"
									                        th:data-tipoTransacao="${transacao.tipoTransacao}"
									                        th:data-categoriaId="${transacao.categoriaId}"
									                        th:data-origemDestino="${transacao.origemDestino}"
									                        th:data-metodoPagamento="${transacao.metodoPagamento}"
									                        th:data-responsavelId="${transacao.responsavelId}"
									                        onclick="abrirModalTransacao('editar', this)">
									                        <i class="fa fa-edit"></i>
									                    </button>

									                    <!-- Bot√£o Excluir -->
									                    <a th:href="@{'/transacoes/excluir/' + ${transacao.id}}"
									                        class="btn btn-sm btn-danger"
									                        onclick="return confirm('Deseja excluir esta transa√ß√£o?');">
									                        <i class="fa fa-trash"></i>
									                    </a>
										            </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
					
					<!-- Modal para Criar e Editar Transa√ß√£o -->
					<div class="modal fade" id="transacaoModal" tabindex="-1" role="dialog" aria-hidden="true">
					    <div class="modal-dialog" role="document">
					        <div class="modal-content">
					            <div class="modal-header border-0">
					                <h5 class="modal-title" id="titulo-modal-transacao">Nova Transa√ß√£o</h5>
					                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
					            </div>
					            <div class="modal-body">
					                <form id="transacaoForm" method="post">
					                    <input type="hidden" id="transacao-id" name="id">
					                    <input type="hidden" id="licitacaoId" name="licitacaoId" th:value="${licitacao.id}">

										<div class="form-group">
										    <label for="descricao">Descri√ß√£o</label>
										    <input type="text" class="form-control" id="descricao" name="descricao" required>
										</div>

										<div class="form-group">
										    <label for="valor">Valor</label>
										    <input type="text" class="form-control money" id="valor" name="valor" required>
										</div>

										<div class="form-group">
										    <label for="tipoTransacao">Tipo</label>
										    <select id="tipoTransacao" name="tipoTransacao" class="form-control" required>
										        <option value="">Selecione o tipo</option>
										        <option value="ENTRADA">Entrada</option>
										        <option value="SAIDA">Sa√≠da</option>
										    </select>
										</div>

										<div class="form-group">
										    <label for="categoria">Categoria</label>
										    <select id="categoria" name="categoriaId" class="form-control" required>
										        <option value="">Selecione uma categoria</option>
										        <option th:each="cat : ${categorias}" th:value="${cat.id}" th:text="${cat.nome}"></option>
										    </select>
										    <div class="invalid-feedback">Escolha uma categoria.</div>
										</div>

										<div class="form-group">
										    <label for="metodoPagamento">M√©todo de Pagamento</label>
										    <select id="metodoPagamento" name="metodoPagamento" class="form-control" required>
										        <option value="">Selecione o m√©todo</option>
										        <option value="DINHEIRO">Dinheiro</option>
										        <option value="PIX">PIX</option>
										        <option value="BOLETO">Boleto</option>
										        <option value="TRANSFERENCIA">Transfer√™ncia</option>
										        <option value="CARTAO_CREDITO">Cart√£o de Cr√©dito</option>
										        <option value="CARTAO_DEBITO">Cart√£o de D√©bito</option>
										    </select>
										    <div class="invalid-feedback">Selecione um m√©todo de pagamento.</div>
										</div>
										
										<div class="form-group">
					                        <label for="origemDestino">Origem/Destino</label>
					                        <input type="text" class="form-control" id="origemDestino" name="origemDestino" required>
					                    </div>

										<div class="form-group">
										    <label for="responsavel">Respons√°vel</label>
										    <select id="responsavel" name="responsavelId" class="form-control" required>
										        <option value="">Selecione um respons√°vel</option>
										        <option th:each="usuario : ${usuarios}" th:value="${usuario.id}" th:text="${usuario.nome}"></option>
										    </select>
										    <div class="invalid-feedback">Escolha um respons√°vel.</div>
										</div>


					                    <button type="submit" id="btnSalvarTransacao" class="btn btn-primary mt-3">Salvar Transa√ß√£o</button>
					                </form>
					            </div>
					        </div>
					    </div>
					</div>



                    <footer th:replace="~{layout :: footer}"></footer>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/scripts :: scripts}"></div>

	<script>
		function abrirModalTransacao(acao, botao = null) {
		       const modal = new bootstrap.Modal(document.getElementById("transacaoModal"));
		       const form = document.getElementById("transacaoForm");

		       if (acao === "criar") {
		           document.getElementById("titulo-modal-transacao").innerText = "Nova Transa√ß√£o";
		           form.action = "/transacoes/salvar"; // Define o endpoint correto
		           form.reset();
		       } else if (acao === "editar") {
		           document.getElementById("titulo-modal-transacao").innerText = "Editar Transa√ß√£o";
		           form.action = "/transacoes/editar/" + botao.getAttribute("data-id");
		           document.getElementById("descricao").value = botao.getAttribute("data-descricao");
		           document.getElementById("valor").value = formatarMoeda(botao.getAttribute("data-valor"));
		           document.getElementById("tipoTransacao").value = botao.getAttribute("data-tipoTransacao");
		           document.getElementById("categoria").value = botao.getAttribute("data-categoriaId");
		           document.getElementById("origemDestino").value = botao.getAttribute("data-origemDestino");
		           document.getElementById("metodoPagamento").value = botao.getAttribute("data-metodoPagamento");
		           document.getElementById("responsavel").value = botao.getAttribute("data-responsavelId");
		       }

		       setTimeout(() => aplicarMascaraCleave(), 200);
		       
		       form.onsubmit = function () {
		           formatCurrencyBeforeSubmit();
		       };

		       modal.show();
		   }

		   // Aplicar Cleave.js para formatar moeda
		   function aplicarMascaraCleave() {
		       document.querySelectorAll(".money").forEach(element => {
		           new Cleave(element, {
		               numeral: true,
		               numeralThousandsGroupStyle: 'thousand',
		               numeralDecimalMark: ',',
		               delimiter: '.',
		               numeralDecimalScale: 2,
		               prefix: 'R$ '
		           });
		       });
		   }

		   // Formatar valores antes de enviar ao backend
		   function formatCurrencyBeforeSubmit() {
		       document.querySelectorAll(".money").forEach(function (element) {
		           let valorFormatado = element.value
		               .replace(/\./g, "") // Remove pontos de milhar
		               .replace(",", ".")  // Substitui v√≠rgula decimal por ponto
		               .replace("R$", "")  // Remove o prefixo "R$"
		               .trim();            // Remove espa√ßos extras

		           element.value = valorFormatado; // Atualiza o campo com o formato correto
		       });
		   }

		   // Formatar valores ao abrir o modal
		   function formatarMoeda(valor) {
		       if (!valor || isNaN(valor)) return "R$ 0,00";

		       let numero = parseFloat(valor).toLocaleString("pt-BR", {
		           minimumFractionDigits: 2,
		           maximumFractionDigits: 2
		       });

		       return `R$ ${numero}`;
		   }

	       document.addEventListener("DOMContentLoaded", function () {
			
			document.getElementById("transacaoForm").addEventListener("submit", function (event) {
			            let isValid = true;

			            // Campos obrigat√≥rios
			            let campos = [
			                "descricao",
			                "valor",
			                "tipoTransacao",
			                "categoria",
			                "metodoPagamento",
							"origemDestino",
			                "responsavel"
			            ];

			            // Valida√ß√£o dos campos
			            campos.forEach(campo => {
			                let elemento = document.getElementById(campo);
			                let valor = elemento.value.trim();

			                if (campo === "valor") {
			                    // Remove prefixo "R$ " e verifica se o campo est√° vazio
			                    valor = valor.replace("R$", "").trim();
			                }

			                if (!valor) {
			                    isValid = false;
			                    elemento.classList.add("is-invalid"); // Adiciona classe de erro visual
			                } else {
			                    elemento.classList.remove("is-invalid"); // Remove erro se o campo for preenchido
			                }
			            });

			            // Bloqueia o envio se houver erros
			            if (!isValid) {
			                event.preventDefault();
			                alert("Por favor, preencha todos os campos obrigat√≥rios corretamente.");
			            }
			        });

	           $('#transacoes-tabela').DataTable({
	               "paging": true,
	               "searching": true,
	               "ordering": false, // üîπ Desativa a ordena√ß√£o autom√°tica
	               "info": true,
	               "lengthMenu": [10, 20, 50],
	               "language": {
	                   "url": "/i18n/Portuguese-Brasil.json"
	               }
	           });

	           aplicarMascaraCleave();
	       });


		
    </script>
</body>
</html>
