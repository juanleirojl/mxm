<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Dashboard')}"></head>
<body>
    <div class="wrapper">
        <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>
        <div class="main-panel">
            <div th:replace="~{fragments/navbar :: navbar}"></div>
            <div class="container">
                <div class="page-inner">
                    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
                        <div>
                            <h3 class="fw-bold mb-3">Dashboard de Vendas</h3>
                        </div>
                    </div>
					
					<div class="row">
					    <div class="col-md-12">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Clientes com Pedidos Pendentes</h4>
					            </div>
					            <div class="card-body">
									<div class="table-responsive">
										<table id="dashboardTable" class="display table table-striped table-hover">
						                    <thead>
						                        <tr>
						                            <th>Cliente</th>
						                            <th>Dias Atraso</th>
						                            <th>Total a Pagar (R$)</th>
						                            <th>Valor Pendente (R$)</th>
						                        </tr>
						                    </thead>
						                    <tbody id="tabelaPedidosPendentes">
						                        <!-- Dados ser√£o preenchidos via JavaScript -->
						                    </tbody>
											<tfoot id="tabelaPedidosPendentesFooter">
											        <tr>
											            <th>Total:</th>
											            <th></th> <!-- Coluna vazia para alinhamento -->
											            <th id="totalPedidosPagar">R$ 0,00</th>
											            <th id="totalPedidosPendentes">R$ 0,00</th>
											        </tr>
											    </tfoot>
						                </table>
									</div>
					            </div>
					        </div>
					    </div>
					</div>

					
					<div class="row">
					    <div class="col-md-6">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Clientes com Pedidos Pendentes</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartPedidosPendentes"></canvas>
					            </div>
					        </div>
					    </div>

					    <div class="col-md-6">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Pagamentos Parciais</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartPagamentosParciais"></canvas>
					            </div>
					        </div>
					    </div>
					</div>

					<div class="row">
					    <div class="col-md-6">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Placas com Mais Pedidos</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartPedidosPlaca"></canvas>
					            </div>
					        </div>
					    </div>

					    <div class="col-md-6">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Motoristas com Mais Pedidos</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartPedidosMotorista"></canvas>
					            </div>
					        </div>
					    </div>
					</div>

					<div class="row">
					    <div class="col-md-12">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Vendas por M√™s</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartVendasMes"></canvas>
					            </div>
					        </div>
					    </div>
					</div>

					<div class="row">
					    <div class="col-md-6">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Top Clientes</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartClientes"></canvas>
					            </div>
					        </div>
					    </div>

					    <div class="col-md-6">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Marcas de Cimento Mais Vendidas</h4>
					            </div>
					            <div class="card-body">
					                <canvas id="chartCimentos"></canvas>
					            </div>
					        </div>
					    </div>
					</div>
					
					<div class="row">
					    <div class="col-md-12">
					        <div class="card">
					            <div class="card-header">
					                <h4 class="card-title">Lista de Empr√©stimos</h4>
					            </div>
					            <div class="card-body">
									<div class="table-responsive">
						                <table id="emprestimoTable" class="table table-striped">
						                    <thead>
						                        <tr>
						                            <th>Data Empr√©stimo</th>
						                            <th>Valor Emprestado (R$)</th>
						                            <th>Valor Pago (R$)</th>
						                            <th>Saldo Devedor (R$)</th>
						                        </tr>
						                    </thead>
						                    <tbody id="tabelaEmprestimos">
						                        <!-- Dados preenchidos via JavaScript -->
						                    </tbody>
						                    <tfoot>
						                        <tr>
						                            <th>Total:</th>
						                            <th id="totalEmprestado">R$ 0,00</th>
						                            <th id="totalPago">R$ 0,00</th>
						                            <th id="totalSaldoDevedor">R$ 0,00</th>
						                        </tr>
						                    </tfoot>
						                </table>
									</div>
					            </div>
					        </div>
					    </div>
					</div>



                <footer th:replace="~{layout :: footer}"></footer>
            </div>
        </div>
        <div th:replace="~{fragments/scripts :: scripts}"></div>
    </div>

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- JavaScript do Dashboard -->
    <script>
		
		$(document).ready(function() {
	           $('#dashboardTable').DataTable({
	               "paging": false,
	               "searching": false,
	               "ordering": false,
				"order": [],
	               "info": false,
	               "lengthMenu": [30, 50, 60],
	               "language": {
	                   "url": "/i18n/Portuguese-Brasil.json"
	               }
	           });
			   
			   $('#emprestimoTable').DataTable({
	   	               "paging": false,
	   	               "searching": false,
	   	               "ordering": false,
	   				"order": [],
	   	               "info": false,
	   	               "lengthMenu": [30, 50, 60],
	   	               "language": {
	   	                   "url": "/i18n/Portuguese-Brasil.json"
	   	               }
	   	           });
	       });
		
		document.addEventListener("DOMContentLoaded", function () {
			carregarPedidosPendentes();
		    carregarPagamentosParciais();
		    carregarPedidosPorPlaca();
		    carregarPedidosPorMotorista();
		    carregarVendasPorMes();
		    carregarVendasPorCliente();
		    carregarVendasPorCimento();
			carregarTabelaPedidosPendentes();
			carregarEmprestimos();
		});
		
		function carregarPedidosPendentes() {
		    fetch('/dashboard/pedidos-pendentes')
		        .then(response => response.json())
		        .then(data => {
		            console.log("Pedidos Pendentes (JSON recebido):", data); // üîç Verifica a resposta recebida

		            let clientes = data.map(d => d.cliente);
		            let valores = data.map(d => d.totalPendente);

		            console.log("Clientes:", clientes); // üîç Confere os clientes extra√≠dos
		            console.log("Valores Pendentes:", valores); // üîç Confere os valores extra√≠dos

		            new Chart(document.getElementById("chartPedidosPendentes"), {
		                type: 'bar',
		                data: {
		                    labels: clientes,
		                    datasets: [{
		                        label: "Valor Pendente R$",
		                        data: valores,
		                        backgroundColor: "red"
		                    }]
		                }
		            });
		        })
		        .catch(error => console.error("Erro ao carregar pedidos pendentes:", error));
		}


		function carregarPagamentosParciais() {
		    fetch('/dashboard/pagamentos-parciais')
		        .then(response => response.json())
		        .then(data => {
		            console.log("Pagamentos Parciais (JSON recebido):", data); // üîç Verifica a resposta no console

		            let clientes = data.map(d => d.cliente);
		            let totaisPagos = data.map(d => d.totalPago);
		            let valoresRestantes = data.map(d => d.valorRestante);

		            console.log("Clientes:", clientes); // üîç Verifica se os nomes aparecem
		            console.log("Totais Pagos:", totaisPagos); // üîç Verifica os valores
		            console.log("Valores Restantes:", valoresRestantes); // üîç Verifica os valores

		            let ctx = document.getElementById("chartPagamentosParciais").getContext("2d");

		            window.chartPagamentosParciais = new Chart(ctx, {
		                type: 'bar',
		                data: {
		                    labels: clientes,
		                    datasets: [
		                        {
		                            label: "Total Pago (R$)",
		                            data: totaisPagos,
		                            backgroundColor: "green"
		                        },
		                        {
		                            label: "Valor Restante (R$)",
		                            data: valoresRestantes,
		                            backgroundColor: "red"
		                        }
		                    ]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false
		                }
		            });
		        })
		        .catch(error => console.error("Erro ao carregar pagamentos parciais:", error));
		}


		function carregarPedidosPorPlaca() {
		    fetch('/dashboard/pedidos-por-placa')
		        .then(response => response.json())
		        .then(data => {
		            let placas = data.map(d => d.placa || "SEM PLACA"); // üîπ Substitui null por "SEM PLACA"
		            let pedidos = data.map(d => d.quantidadePedidos);

		            new Chart(document.getElementById("chartPedidosPlaca"), {
		                type: 'pie',
		                data: {
		                    labels: placas,
		                    datasets: [{
		                        data: pedidos,
		                        backgroundColor: ["purple", "orange", "green"]
		                    }]
		                }
		            });
		        });
		}
		
		function carregarPedidosPorMotorista() {
		    fetch('/dashboard/pedidos-por-motorista')
		        .then(response => response.json())
		        .then(data => {
		            console.log("Pedidos por Motorista:", data); // üîç Verifica a resposta no console

		            let motoristas = data.map(d => d.motorista || "SEM MOTORISTA"); // üîπ Substitui null por "SEM MOTORISTA"
		            let totalPedidos = data.map(d => d.quantidadePedidos);

		            let ctx = document.getElementById("chartPedidosMotorista").getContext("2d");


		            window.chartPedidosMotorista = new Chart(ctx, {
		                type: 'bar',
		                data: {
		                    labels: motoristas,
		                    datasets: [{
		                        label: "Total de Pedidos",
		                        data: totalPedidos,
		                        backgroundColor: "blue"
		                    }]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false
		                }
		            });
		        })
		        .catch(error => console.error("Erro ao carregar pedidos por motorista:", error));
		}


		function carregarVendasPorMes() {
		    fetch('/dashboard/vendas-por-mes') // <- Corrigimos a URL aqui!
		        .then(response => response.json())
		        .then(data => {
		            let meses = data.map(d => d.mes + "/" + d.ano);
		            let quantidades = data.map(d => d.quantidade);
		            let valores = data.map(d => d.totalVendas);

		            new Chart(document.getElementById("chartVendasMes"), {
		                type: 'line',
		                data: {
		                    labels: meses,
		                    datasets: [
		                        {
		                            label: "Quantidade de Sacos",
		                            data: quantidades,
		                            borderColor: "blue",
		                            fill: false
		                        },
		                        {
		                            label: "Valor Total R$",
		                            data: valores,
		                            borderColor: "green",
		                            fill: false
		                        }
		                    ]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false
		                }
		            });
		        });
		}

		function carregarVendasPorCliente() {
		    fetch('/dashboard/vendas-por-cliente') // <- Corrigimos a URL aqui!
		        .then(response => response.json())
		        .then(data => {
		            let clientes = data.map(d => d.cliente);
		            let valores = data.map(d => d.totalVendas);

		            new Chart(document.getElementById("chartClientes"), {
		                type: 'bar',
		                data: {
		                    labels: clientes,
		                    datasets: [{
		                        label: "Valor Total R$",
		                        data: valores,
		                        backgroundColor: "orange"
		                    }]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false
		                }
		            });
		        });
		}

		function carregarVendasPorCimento() {
		    fetch('/dashboard/vendas-por-cimento') // <- Corrigimos a URL aqui!
		        .then(response => response.json())
		        .then(data => {
		            let marcas = data.map(d => d.marca);
		            let quantidades = data.map(d => d.quantidade);

		            new Chart(document.getElementById("chartCimentos"), {
		                type: 'pie',
		                data: {
		                    labels: marcas,
		                    datasets: [{
		                        label: "Quantidade Vendida",
		                        data: quantidades,
		                        backgroundColor: ["red", "blue", "green", "purple", "orange"]
		                    }]
		                },
		                options: {
		                    responsive: true,
		                    maintainAspectRatio: false
		                }
		            });
		        });
		}
		
		function carregarTabelaPedidosPendentes() {
		    fetch('/dashboard/pedidos-pendentes-tabela')
		        .then(response => response.json())
		        .then(data => {
		            console.log("Pedidos Pendentes Tabela:", data); // üîç Debug no Console

		            let tabela = document.getElementById("tabelaPedidosPendentes");
		            tabela.innerHTML = ""; // Limpa a tabela antes de preencher

		            let totalPagar = 0;
		            let totalPendentes = 0;

		            data.forEach(d => {
		                totalPagar += parseFloat(d.totalAPagar);
		                totalPendentes += parseFloat(d.valorPendente);

		                let row = `
		                    <tr>
		                        <td>${d.cliente}</td>
		                        <td>${d.diasAtraso} dias</td>
		                        <td>R$ ${d.totalAPagar.toFixed(2)}</td>
		                        <td>R$ ${d.valorPendente.toFixed(2)}</td>
		                    </tr>
		                `;
		                tabela.innerHTML += row;
		            });

		            // Atualiza os totais no rodap√© da tabela
		            document.getElementById("totalPedidosPagar").innerText = formatarMoedaComRS(totalPagar);
		            document.getElementById("totalPedidosPendentes").innerText = formatarMoedaComRS(totalPendentes);
		        })
		        .catch(error => console.error("Erro ao carregar tabela de pedidos pendentes:", error));
		}

		function carregarEmprestimos() {
		    fetch('/dashboard/emprestimos')
		        .then(response => response.json())
		        .then(data => {
		            console.log("Empr√©stimos recebidos:", data); // üîç Debug no console

		            let tabela = document.getElementById("tabelaEmprestimos");
		            tabela.innerHTML = ""; // Limpa a tabela antes de preencher

		            let totalEmprestado = 0;
		            let totalPago = 0;
		            let totalSaldoDevedor = 0;

		            data.forEach(d => {
		                let saldoDevedor = d.valorEmprestado - (d.valorPago || 0);

		                totalEmprestado += parseFloat(d.valorEmprestado);
		                totalPago += parseFloat(d.valorPago || 0);
		                totalSaldoDevedor += saldoDevedor;

		                let corSaldo = saldoDevedor === 0 ? "green" : "red";

		                let row = `
		                    <tr>
		                        <td>${formatarData(d.dataEmprestimo)}</td>
		                        <td>${formatarMoedaComRS(d.valorEmprestado)}</td>
		                        <td>${formatarMoedaComRS(d.valorPago)}</td>
		                        <td style="color: ${corSaldo}; font-weight: bold;">${formatarMoedaComRS(saldoDevedor)}</td>
		                    </tr>
		                `;
		                tabela.innerHTML += row;
		            });

		            // Atualiza os totais no rodap√© da tabela
		            document.getElementById("totalEmprestado").innerText = formatarMoedaComRS(totalEmprestado);
		            document.getElementById("totalPago").innerText = formatarMoedaComRS(totalPago);
		            document.getElementById("totalSaldoDevedor").innerText = formatarMoedaComRS(totalSaldoDevedor);
		            document.getElementById("totalSaldoDevedor").style.color = totalSaldoDevedor === 0 ? "green" : "red";
		        })
		        .catch(error => console.error("Erro ao carregar a tabela de empr√©stimos:", error));
		}

		// Fun√ß√£o para formatar moeda com "R$"
		function formatarMoedaComRS(valor) {
		    return "R$ " + parseFloat(valor).toLocaleString("pt-BR", {
		        minimumFractionDigits: 2,
		        maximumFractionDigits: 2
		    });
		}

		// Fun√ß√£o para formatar data de "AAAA-MM-DD" para "DD/MM/AAAA"
		function formatarData(data) {
		    if (!data) return "-";
		    let partes = data.split("-");
		    return `${partes[2]}/${partes[1]}/${partes[0]}`;
		}


    </script>
</body>
</html>
